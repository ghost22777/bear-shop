<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¯ Lucky Pet Case - Bear Shop</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{background:#150015;color:white;font-family:Arial,sans-serif;margin:0;text-align:center}
    .navbar{background:#1a001a;padding:12px 0;display:flex;justify-content:center;gap:25px;font-weight:bold;box-shadow:0 0 10px #ff00ff}
    .navbar a{color:orange;text-decoration:none;transition:0.2s}
    .navbar a:hover{color:#ff00ff;text-shadow:0 0 5px #ff00ff}
    h1{color:#ffccff;text-shadow:0 0 10px #ff00ff}
    .case-container{width:85%;margin:25px auto;min-height:140px;background:rgba(40,0,40,0.9);border:3px solid #ff00ff;border-radius:10px;overflow:hidden;box-shadow:0 0 20px #ff00ff;position:relative}
    .case-strip{display:flex}
    .item{width:120px;text-align:center;background:#220022;border-right:2px solid #ff00ff55}
    .item img{width:100px;height:100px;border-radius:6px}
    .item span{display:block;font-size:13px;color:#ffccff}
    .center-line{position:absolute;top:0;left:50%;width:3px;height:100%;background:yellow;box-shadow:0 0 10px yellow;transform:translateX(-50%);z-index:9}
    .case-btn{margin:20px auto;background:#ff00ff;color:white;border:none;padding:12px 30px;font-weight:bold;border-radius:8px;font-size:18px;cursor:pointer;box-shadow:0 0 15px #ff00ff;transition:0.2s;display:block;width:200px}
    .case-btn:hover{background:#ff33ff;box-shadow:0 0 25px #ff00ff}
    #result{font-size:24px;font-weight:bold;color:#00ffea;text-shadow:0 0 10px #00fff2;margin-top:15px}
    .neon-fly{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:28px;color:#fff;text-shadow:0 0 10px #ff00ff;animation:flyUp 1.5s forwards;z-index:1000}
    @keyframes flyUp{0%{opacity:1}100%{opacity:0;transform:translate(-50%,-150%) scale(1.3)}}
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="logo">ğŸ» Bear Shop</a>
    <a href="index.html">ğŸ Case Opening</a>
    <a href="shop.html">ğŸ›’ Pet Shop</a>
    <a href="inventory.html">ğŸ’ Inventory</a>
    <a href="history.html">ğŸ“œ History</a>
    <a id="adminLink" href="admin_withdraws.html" style="display:none;">âš™ï¸ Admin</a>
    <span id="userInfo"></span>
  </nav>

  <h1>ğŸ¯ Lucky Pet Case ğŸ¯</h1>
  <div class="case-container">
    <div class="center-line"></div>
    <div class="case-strip" id="caseStrip"></div>
  </div>
  <button id="openCase" class="case-btn" disabled>OPEN CASE ($1.00)</button>
  <div id="result"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="pets.js"></script>

<script>
const firebaseConfig={apiKey:"AIzaSyBUCFW2ffGXPBogDUyd1cDYEt15fHQiz9I",authDomain:"bearshop-49b90.firebaseapp.com",projectId:"bearshop-49b90",storageBucket:"bearshop-49b90.firebasestorage.app",messagingSenderId:"764985024020",appId:"1:764985024020:web:62e152b71173d2f3c89101"};
if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();

// âœ… Giá»¯ session Ä‘Äƒng nháº­p
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);

let currentUser=null,userDocRef=null;
const strip=document.getElementById("caseStrip");
const btn=document.getElementById("openCase");
const result=document.getElementById("result");
const casePrice=1,itemWidth=120,containerWidth=strip.parentElement.offsetWidth;
let spinning=false,wheel=1;

// âœ… Kiá»ƒm tra login (cÃ³ delay Ä‘á»ƒ trÃ¡nh redirect sá»›m)
auth.onAuthStateChanged(async u=>{
  if(!u){
    setTimeout(()=>{if(!auth.currentUser)location.href="login.html";},1000);
    return;
  }
  userDocRef=db.collection("users").doc(u.uid);
  const d=await userDocRef.get();
  if(!d.exists){alert("User data not found!");auth.signOut();return location.href="login.html";}
  currentUser={uid:u.uid,...d.data()};
  renderUserUI();
  btn.disabled=false; 
  if(currentUser.isAdmin)document.getElementById("adminLink").style.display="inline-block";
  createMainStrip(false,0);
});

function renderUserUI(){
  const ui=document.getElementById("userInfo");
  ui.innerHTML=`
    ğŸ‘¤ ${currentUser.username} | ğŸ’° $${(currentUser.balance||0).toFixed(2)}
    <button id="addFundsBtn" style="background:#0080ff;color:white;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;margin-left:5px;">Add Funds</button>
    <button id="logoutBtn" style="background:red;color:white;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;margin-left:5px;">Logout</button>
  `;
  document.getElementById("addFundsBtn").onclick=showAddFundsDialog;
  document.getElementById("logoutBtn").onclick=()=>auth.signOut().then(()=>location.href="login.html");
}

function showAddFundsDialog(){
  if(document.getElementById("fundPopup"))return;
  const p=document.createElement("div");
  p.id="fundPopup";
  p.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#000c;padding:20px;color:white;border-radius:8px;box-shadow:0 0 15px #ff00ff;z-index:2000";
  p.innerHTML=`<h2>Add Funds</h2><p>Contact admin on Discord: <a href="https://discord.gg/Cheapestgag" target="_blank" style="color:#00ffff">BearShop</a></p>
  <button onclick="document.getElementById('fundPopup').remove()" style="margin-top:10px;background:#ff00ff;border:none;padding:6px 12px;border-radius:5px;color:white">Close</button>`;
  document.body.appendChild(p);
}

async function updateBalance(v){const nb=(currentUser.balance||0)+v;await userDocRef.update({balance:nb});currentUser.balance=nb;renderUserUI();}
async function addInv(n,t){await db.collection("inventory").add({userId:currentUser.uid,username:currentUser.username,item:n,type:t,createdAt:firebase.firestore.FieldValue.serverTimestamp()});}
async function saveHist(t,m){await db.collection("history").add({userId:currentUser.uid,username:currentUser.username,type:t,msg:m,createdAt:firebase.firestore.FieldValue.serverTimestamp()});}

function createMainStrip(p,index){strip.innerHTML="";for(let i=0;i<80;i++)strip.innerHTML+=`<div class="item"><img src="${i===index&&p?'images/pet_reward.png':'images/Sheckles.png'}"><span>${i===index&&p?'Pet Reward':'x1 700T+ Sheckles'}</span></div>`;}
function createPetStrip(){strip.innerHTML="";for(let i=0;i<80;i++)strip.innerHTML+=`<div class="item"><img src="images/pet_reward.png"><span>Pet Reward</span></div>`;}

function spin(target,cb){let pos=0,vel=90;function animate(){pos+=vel;vel*=0.965;if(vel<0.5||pos>=target){strip.style.transform=`translateX(-${target}px)`;cb();return;}strip.style.transform=`translateX(-${pos}px)`;requestAnimationFrame(animate);}animate();}
function floating(t){const d=document.createElement("div");d.className="neon-fly";d.textContent=t;document.body.appendChild(d);setTimeout(()=>d.remove(),1500);}

btn.onclick=async()=>{
 if(!currentUser){alert("âš ï¸ User data is loading, please wait...");return;}
 if(spinning)return;
 if((currentUser.balance||0)<casePrice)return alert("âŒ Not enough balance!");
 spinning=true;btn.disabled=true;btn.style.opacity="0.5";result.textContent="";

 if(wheel===1){
   await updateBalance(-casePrice);
   const petWin=Math.random()<0.1;
   const idx=Math.floor(Math.random()*50)+15;
   createMainStrip(petWin,idx);
   const target=idx*itemWidth-containerWidth/2+itemWidth/2;

   spin(target,async()=>{
     if(petWin){
       wheel=2;btn.textContent="SPIN PET WHEEL";createPetStrip();
       const pIdx=Math.floor(Math.random()*50)+15;
       const t2=pIdx*itemWidth-containerWidth/2+itemWidth/2;
       spin(t2,async()=>{
         const pet=petList[Math.floor(Math.random()*petList.length)];
         await addInv(pet.name,"pet");
         await saveHist("case",`Got pet ${pet.name}`);
         result.textContent=`ğŸ‰ You got pet: ${pet.name}`;
         floating(`ğŸ‰ ${pet.name}`);
         wheel=1;btn.textContent="OPEN CASE ($1.00)";
         spinning=false;btn.disabled=false;btn.style.opacity="1";
       });
     } else {
       await addInv("x1 700T+ Sheckles","money");
       await saveHist("case","Got x1 700T+ Sheckles");
       result.textContent="ğŸ’° You got x1 700T+ Sheckles";
       floating("ğŸ’° Sheckles");
       wheel=1;btn.textContent="OPEN CASE ($1.00)";
       spinning=false;btn.disabled=false;btn.style.opacity="1";
     }
   });
 }
};
</script>
</body>
</html>
