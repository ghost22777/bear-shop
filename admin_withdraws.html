<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>âš™ï¸ Admin Panel - Bear Shop (Secure)</title>
<style>
  body { background:#150015; color:white; font-family:Arial,sans-serif; text-align:center; margin:0; }
  h1, h2, h3 { color:#ffccff; text-shadow:0 0 10px #ff00ff; }
  table { width:95%; margin:20px auto; border-collapse:collapse; background:#1c1c1c; box-shadow:0 0 10px #ff00ff; }
  th, td { border:1px solid #333; padding:8px; word-wrap:break-word; }
  th { background:#ff00ff; color:black; }
  tr.pending { background:#331133; }
  button { background:limegreen; color:white; border:none; padding:5px 10px; margin:2px; border-radius:5px; cursor:pointer; }
  button:hover { background:green; }
  .danger { background:red !important; }
  .user-card { border:1px solid #ff00ff; padding:10px; margin:10px auto; width:95%; background:#1c1c1c; border-radius:8px; text-align:left; }
  ul { padding-left:20px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>âš™ï¸ Admin Panel (Improved)</h1>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyBUCFW2ffGXPBogDUyd1cDYEt15fHQiz9I",
  authDomain:"bearshop-49b90.firebaseapp.com",
  projectId:"bearshop-49b90",
  storageBucket:"bearshop-49b90.firebasestorage.app",
  messagingSenderId:"764985024020",
  appId:"1:764985024020:web:62e152b71173d2f3c89101"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();

let currentUser=null;

auth.onAuthStateChanged(async (user)=>{
  if(!user){alert("ğŸš« Please login first.");location.href="login.html";return;}
  const snap=await db.collection("users").doc(user.uid).get();
  if(!snap.exists || !snap.data().isAdmin){alert("ğŸš« Access denied!");location.href="index.html";return;}
  currentUser={uid:user.uid,...snap.data()};
  loadUsers(); loadWithdraws();
});

// âœ… Fetch helpers
async function getUsers(){return (await db.collection("users").get()).docs.map(d=>({id:d.id,...d.data()}));}
async function getInventory(){return (await db.collection("inventory").get()).docs.map(d=>({id:d.id,...d.data()}));}
async function getWithdraws(){return (await db.collection("withdraws").get()).docs.map(d=>({id:d.id,...d.data()}));}

// âœ… Render Users
async function loadUsers(){
  const c=document.getElementById("userList");
  c.innerHTML="â³ Loading...";
  try{
    const users=await getUsers(), inv=await getInventory(); c.innerHTML="";
    users.forEach(u=>{
      const pets=inv.filter(i=>i.userId===u.id&&i.type==="pet");
      const sheck=inv.filter(i=>i.userId===u.id&&i.type==="money");
      const div=document.createElement("div");
      div.className="user-card";
      div.innerHTML=`
        <h3>${u.username||u.email} - Balance: $${(u.balance||0).toFixed(2)}</h3>
        <button onclick="resetBalance('${u.id}')">Reset Balance</button>
        <button class="danger" onclick="deleteUser('${u.id}')">ğŸ—‘ï¸ Delete User (All Data)</button>
        <button class="danger" onclick="deleteAllItems('${u.id}')">ğŸ—‘ï¸ Delete All Items</button>
        <h4>ğŸ¾ Pets:</h4>
        <ul>${pets.length?pets.map(p=>`<li>${p.item} <button onclick="deleteItem('${p.id}')">âŒ</button></li>`).join(""):"<li>No pets</li>"}</ul>
        <h4>ğŸ’° Sheckles:</h4>
        <ul>${sheck.length?sheck.map(s=>`<li>${s.item} <button onclick="deleteItem('${s.id}')">âŒ</button></li>`).join(""):"<li>No sheckles</li>"}</ul>
      `;
      c.appendChild(div);
    });
  }catch(e){c.innerHTML=`<p style="color:red">âŒ ${e.message}</p>`;}
}

// âœ… Admin Actions
async function resetBalance(id){await db.collection("users").doc(id).update({balance:0});alert("âœ… Balance reset!");loadUsers();}
async function deleteItem(id){await db.collection("inventory").doc(id).delete();alert("âœ… Item deleted.");loadUsers();}
async function deleteAllItems(uid){
  if(!confirm("âš ï¸ Delete all items of this user?"))return;
  const batch=db.batch();
  const inv=await db.collection("inventory").where("userId","==",uid).get();inv.forEach(d=>batch.delete(d.ref));
  await batch.commit();alert("âœ… All items deleted.");loadUsers();
}
async function deleteUser(uid){
  if(!confirm("âš ï¸ Delete this user and all their data?"))return;
  const batch=db.batch();
  const inv=await db.collection("inventory").where("userId","==",uid).get();inv.forEach(d=>batch.delete(d.ref));
  const his=await db.collection("history").where("userId","==",uid).get();his.forEach(d=>batch.delete(d.ref));
  const wds=await db.collection("withdraws").where("userId","==",uid).get();wds.forEach(d=>batch.delete(d.ref));
  await batch.commit(); await db.collection("users").doc(uid).delete();
  alert("âœ… User deleted."); loadUsers();
}

// âœ… Withdraw Requests
async function loadWithdraws(){
  const t=document.getElementById("withdrawTable"); t.innerHTML="";
  const reqs=await getWithdraws(); 
  if(!reqs.length){t.innerHTML="<tr><td colspan='6'>âš ï¸ No withdraw requests.</td></tr>";return;}
  reqs.forEach(r=>{
    const tr=document.createElement("tr");
    if((r.status||"pending").toLowerCase()=="pending") tr.classList.add("pending");
    tr.innerHTML=`
      <td>${r.username||"Unknown"}</td>
      <td>${r.item}</td>
      <td>${r.name}</td>
      <td><span style="color:#00ffff">${r.link}</span></td>
      <td>${r.status||"pending"}</td>
      <td><button onclick="markDone('${r.id}')">âœ… Mark Done</button>
          <button class="danger" onclick="deleteWithdraw('${r.id}')">ğŸ—‘ï¸ Delete</button></td>
    `;
    t.appendChild(tr);
  });
}
async function markDone(id){await db.collection("withdraws").doc(id).update({status:"done"});alert("âœ… Marked as Done.");loadWithdraws();}
async function deleteWithdraw(id){await db.collection("withdraws").doc(id).delete();alert("âœ… Request deleted.");loadWithdraws();}
async function deleteAllWithdraws(){
  if(!confirm("âš ï¸ Delete ALL withdraw requests?"))return;
  const snap=await db.collection("withdraws").get();
  const batch=db.batch(); snap.forEach(d=>batch.delete(d.ref));
  await batch.commit(); alert("âœ… All withdraw requests deleted."); loadWithdraws();
}
</script>

<div style="width:90%;margin:20px auto;background:#1c1c1c;padding:10px;border-radius:8px;box-shadow:0 0 10px #00ffff;">
  <h3>ğŸ’° Add Money</h3>
  <input type="text" id="targetUser" placeholder="Username or Email">
  <input type="number" id="amount" placeholder="Amount">
  <button onclick="addMoney()">âœ… Add</button>
</div>

<h2>ğŸ‘¥ Users</h2>
<div id="userList"></div>

<h2>ğŸ“‹ Withdraw Requests <button class="danger" onclick="deleteAllWithdraws()">ğŸ—‘ï¸ Delete All</button></h2>
<table>
<thead><tr><th>User</th><th>Item</th><th>In-Game Name</th><th>VIP Link</th><th>Status</th><th>Action</th></tr></thead>
<tbody id="withdrawTable"></tbody>
</table>
</body>
</html>