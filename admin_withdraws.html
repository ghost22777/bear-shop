<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>⚙️ Admin Panel - Bear Shop (Secure)</title>
  <style>
    body { background:#150015; color:white; font-family:Arial,sans-serif; text-align:center; margin:0; }
    h1, h2, h3 { color:#ffccff; text-shadow:0 0 10px #ff00ff; }
    table { width:90%; margin:20px auto; border-collapse:collapse; background:#1c1c1c; box-shadow:0 0 10px #ff00ff; }
    th, td { border:1px solid #333; padding:8px; }
    th { background:#ff00ff; color:black; }
    button { background:limegreen; color:white; border:none; padding:5px 10px; margin:2px; border-radius:5px; cursor:pointer; }
    button:hover { background:green; }
    .danger { background:red !important; }
    .user-card { border:1px solid #ff00ff; padding:10px; margin:10px auto; width:90%; background:#1c1c1c; border-radius:8px; text-align:left; }
    ul { padding-left:20px; }
  </style>

  <!-- ✅ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>⚙️ Admin Panel (Secured)</h1>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyBUCFW2ffGXPBogDUyd1cDYEt15fHQiz9I",
  authDomain:"bearshop-49b90.firebaseapp.com",
  projectId:"bearshop-49b90",
  storageBucket:"bearshop-49b90.firebasestorage.app",
  messagingSenderId:"764985024020",
  appId:"1:764985024020:web:62e152b71173d2f3c89101"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();

let currentUser=null;

// ✅ Check admin login
auth.onAuthStateChanged(async (user)=>{
  if(!user){alert("🚫 Please login first.");location.href="login.html";return;}
  const snap=await db.collection("users").doc(user.uid).get();
  if(!snap.exists || !snap.data().isAdmin){alert("🚫 Access denied!");location.href="index.html";return;}
  currentUser={uid:user.uid,...snap.data()};
  loadUsers(); loadWithdraws();
});

// ✅ Fetch helpers
async function getUsers(){return (await db.collection("users").get()).docs.map(d=>({id:d.id,...d.data()}));}
async function getInventory(){return (await db.collection("inventory").get()).docs.map(d=>({id:d.id,...d.data()}));}
async function getWithdraws(){return (await db.collection("withdraws").get()).docs.map(d=>({id:d.id,...d.data()}));}

// ✅ Render Users
async function loadUsers(){
  const c=document.getElementById("userList");
  c.innerHTML="⏳ Loading...";
  try{
    const users=await getUsers(), inv=await getInventory(); c.innerHTML="";
    users.forEach(u=>{
      const pets=inv.filter(i=>i.userId===u.id&&i.type==="pet");
      const sheck=inv.filter(i=>i.userId===u.id&&i.type==="money");
      const div=document.createElement("div");
      div.className="user-card";
      div.innerHTML=`
        <h3>${u.username||u.email} - Balance: $${(u.balance||0).toFixed(2)}</h3>
        <button onclick="resetBalance('${u.id}')">Reset Balance</button>
        <button class="danger" onclick="deleteUser('${u.id}')">🗑️ Delete User (All Data)</button>
        <h4>🐾 Pets:</h4>
        <ul>${pets.length?pets.map(p=>`<li>${p.item} <button onclick="deleteItem('${p.id}')">❌</button></li>`).join(""):"<li>No pets</li>"}</ul>
        <h4>💰 Sheckles:</h4>
        <ul>${sheck.length?sheck.map(s=>`<li>${s.item} <button onclick="deleteItem('${s.id}')">❌</button></li>`).join(""):"<li>No sheckles</li>"}</ul>
      `;
      c.appendChild(div);
    });
  }catch(e){c.innerHTML=`<p style="color:red">❌ Error: ${e.message}</p>`;}
}

// ✅ Admin Actions
async function resetBalance(id){await db.collection("users").doc(id).update({balance:0});alert("✅ Balance reset!");loadUsers();}
async function deleteItem(id){await db.collection("inventory").doc(id).delete();alert("✅ Item deleted.");loadUsers();}
async function deleteUser(uid){
  if(!confirm("⚠️ Delete this user and all their data?"))return;
  const batch=db.batch();
  const inv=await db.collection("inventory").where("userId","==",uid).get();inv.forEach(d=>batch.delete(d.ref));
  const his=await db.collection("history").where("userId","==",uid).get();his.forEach(d=>batch.delete(d.ref));
  const wds=await db.collection("withdraws").where("userId","==",uid).get();wds.forEach(d=>batch.delete(d.ref));
  await batch.commit(); await db.collection("users").doc(uid).delete();
  alert("✅ User deleted."); loadUsers();
}
async function addMoney(){
  const name=document.getElementById("targetUser").value.trim();
  const amount=parseFloat(document.getElementById("amount").value);
  if(!name||isNaN(amount)||amount<=0)return alert("⚠️ Enter valid data!");
  const users=await getUsers(); const u=users.find(x=>x.username===name||x.email===name);
  if(!u)return alert("❌ User not found");
  await db.collection("users").doc(u.id).update({balance:(u.balance||0)+amount});
  alert(`✅ Added $${amount} to ${u.username}`); loadUsers();
}

// ✅ Withdraw Requests
async function loadWithdraws(){
  const t=document.getElementById("withdrawTable"); t.innerHTML="";
  const reqs=await getWithdraws(); 
  if(!reqs.length){t.innerHTML="<tr><td colspan='6'>⚠️ No requests</td></tr>";return;}
  reqs.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.username||"Unknown"}</td>
      <td>${r.item}</td>
      <td>${r.name}</td>
      <td><a href="${r.link}" target="_blank">VIP Link</a></td>
      <td>${r.status||"pending"}</td>
      <td><button onclick="markDone('${r.id}')">✅ Done</button></td>
    `;
    t.appendChild(tr);
  });
}
async function markDone(id){await db.collection("withdraws").doc(id).delete();alert("✅ Request removed.");loadWithdraws();}
</script>

<div style="width:90%;margin:20px auto;background:#1c1c1c;padding:10px;border-radius:8px;box-shadow:0 0 10px #00ffff;">
  <h3>💰 Add Money</h3>
  <input type="text" id="targetUser" placeholder="Username or Email">
  <input type="number" id="amount" placeholder="Amount">
  <button onclick="addMoney()">✅ Add</button>
</div>

<h2>👥 Users</h2>
<div id="userList"></div>

<h2>📋 Withdraw Requests</h2>
<table>
<thead><tr><th>User</th><th>Item</th><th>Name</th><th>Link</th><th>Status</th><th>Action</th></tr></thead>
<tbody id="withdrawTable"></tbody>
</table>

</body>
</html>
