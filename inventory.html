<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üêæ Inventory - Bear Shop</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background:#150015; color:white; font-family:Arial,sans-serif; margin:0; text-align:center; }
    .navbar { background:#1a001a; padding:12px 0; display:flex; justify-content:center; gap:25px; font-weight:bold; box-shadow:0 0 10px #ff00ff; }
    .navbar a { color:orange; text-decoration:none; transition:0.2s; }
    .navbar a:hover { color:#ff00ff; text-shadow:0 0 5px #ff00ff; }
    h1 { color:#ffccff; text-shadow:0 0 10px #ff00ff; margin-top:15px; }
    .inventory { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:20px; padding:20px; max-width:1000px; margin:auto; }
    .inv-item { background:rgba(40,0,40,0.9); border:2px solid #ff00ff; border-radius:12px; padding:12px; box-shadow:0 0 15px #ff00ff55; text-align:center; transition:0.3s; position:relative; }
    .inv-item:hover { transform:scale(1.05); box-shadow:0 0 25px #ff00ff; }
    .inv-item img { width:100%; height:120px; object-fit:contain; border-radius:8px; margin-bottom:8px; box-shadow:0 0 10px #ff00ff33; background:#1a001a; }
    .inv-item h4 { color:#fff; margin:5px 0; text-shadow:0 0 5px #ff00ff; }
    .select-item { position:absolute; top:10px; left:10px; transform:scale(1.3); cursor:pointer; }
    .btn { background:#ff00ff; color:white; border:none; padding:10px 20px; font-weight:bold; border-radius:6px; cursor:pointer; box-shadow:0 0 10px #ff00ff; transition:0.2s; margin:15px auto; display:block; }
    .btn:hover { background:#ff33ff; box-shadow:0 0 20px #ff00ff; }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="logo">üêª Bear Shop</a>
    <a href="index.html">üéÅ Case Opening</a>
    <a href="shop.html">üõí Pet Shop</a>
    <a href="inventory.html">üéí Inventory</a>
    <a href="history.html">üìú History</a>
    <a id="adminLink" href="admin_withdraws.html" style="display:none;">‚öôÔ∏è Admin</a>
    <span id="userInfo"></span>
  </nav>

  <h1>üêæ Your Inventory</h1>
  <div id="inventoryContainer" class="inventory"></div>
  <button class="btn" onclick="withdrawSelected()">Withdraw Selected</button>

  <!-- ‚úÖ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBUCFW2ffGXPBogDUyd1cDYEt15fHQiz9I",
  authDomain: "bearshop-49b90.firebaseapp.com",
  projectId: "bearshop-49b90",
  storageBucket: "bearshop-49b90.firebasestorage.app",
  messagingSenderId: "764985024020",
  appId: "1:764985024020:web:62e152b71173d2f3c89101"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let userDocRef = null;

// ‚úÖ L·∫Øng nghe tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
auth.onAuthStateChanged(async (user) => {
  if (!user) return location.href = "login.html";
  userDocRef = db.collection("users").doc(user.uid);

  // ‚úÖ Lu√¥n nghe thay ƒë·ªïi t·ª´ Firestore (Realtime Update)
  userDocRef.onSnapshot(snap => {
    if (!snap.exists) { auth.signOut(); return location.href = "login.html"; }
    currentUser = { uid: user.uid, ...snap.data() };
    renderUserUI();
    if (currentUser.isAdmin) document.getElementById("adminLink").style.display = "inline-block";
    loadInventory(user.uid);
  });
});

// ‚úÖ Render UI User
function renderUserUI() {
  document.getElementById("userInfo").innerHTML = `
    üë§ ${currentUser.username} | üí∞ $${(currentUser.balance || 0).toFixed(2)}
    <button id="addFundsBtn" style="background:#0080ff;color:white;padding:4px 10px;border:none;border-radius:4px;margin-left:5px;">Add Funds</button>
    <button id="logoutBtn" style="background:red;color:white;padding:4px 10px;border:none;border-radius:4px;margin-left:5px;">Logout</button>`;
  document.getElementById("addFundsBtn").onclick = showAddFundsDialog;
  document.getElementById("logoutBtn").onclick = () => auth.signOut().then(() => location.href = "login.html");
}

// ‚úÖ Popup Add Funds
function showAddFundsDialog() {
  if (document.getElementById("fundPopup")) return;
  const p = document.createElement("div");
  p.id = "fundPopup";
  p.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#000c;padding:20px;color:white;border-radius:8px;box-shadow:0 0 15px #ff00ff;z-index:2000";
  p.innerHTML = `<h2>Add Funds</h2>
    <p>Contact admin on Discord: <a href="https://discord.gg/Cheapestgag" target="_blank" style="color:#00ffff">BearShop</a></p>
    <button onclick="document.getElementById('fundPopup').remove()" style="margin-top:10px;background:#ff00ff;border:none;padding:6px 12px;border-radius:5px;color:white">Close</button>`;
  document.body.appendChild(p);
}

// ‚úÖ Load Inventory an to√†n
async function loadInventory(uid) {
  const container = document.getElementById("inventoryContainer");
  container.innerHTML = "<h3>‚è≥ Loading...</h3>";

  try {
    const snap = await db.collection("inventory").where("userId", "==", uid).get();

    if (snap.empty) {
      container.innerHTML = "<h3>‚ö†Ô∏è Your inventory is empty.</h3>";
      return;
    }

    container.innerHTML = "";
    snap.forEach(doc => {
      const item = doc.data();
      const img = item.type === "pet" ? `images/${item.item}.png` : "images/Sheckles.png";
      container.innerHTML += `
        <div class="inv-item">
          <input type="checkbox" class="select-item" data-id="${doc.id}">
          <img src="${img}" alt="${item.item}">
          <h4>${item.item}</h4>
        </div>`;
    });
  } catch (err) {
    container.innerHTML = `<h3 style="color:red">‚ùå Error loading inventory: ${err.message}</h3>`;
  }
}

// ‚úÖ Withdraw Items
async function withdrawSelected() {
  const user = auth.currentUser;
  if (!user) return alert("‚ö†Ô∏è Please login first!");

  const selected = document.querySelectorAll(".select-item:checked");
  if (!selected.length) return alert("‚ö†Ô∏è Select at least one item!");

  const name = prompt("Enter your in-game name:");
  if (!name) return;
  const link = prompt("Enter your VIP server link:");
  if (!link) return;

  const ids = Array.from(selected).map(cb => cb.dataset.id);
  const batch = db.batch();
  const items = [];

  for (const id of ids) {
    const ref = db.collection("inventory").doc(id);
    const doc = await ref.get();
    if (doc.exists && doc.data().userId === user.uid) { // ‚úÖ NgƒÉn user x√≥a item c·ªßa ng∆∞·ªùi kh√°c
      items.push(doc.data().item);
      batch.delete(ref);
    }
  }

  if (!items.length) return alert("‚ö†Ô∏è No valid items found.");

  await db.collection("withdraws").add({
    userId: user.uid,
    username: currentUser.username,
    item: items.join(", "),
    name,
    link,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: "pending"
  });

  await batch.commit();
  alert("‚úÖ Withdraw request sent successfully!");
  loadInventory(user.uid);
}
</script>
</body>
</html>
