<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìú History - Bear Shop</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background:#150015; color:white; font-family:Arial,sans-serif; margin:0; text-align:center; }
    .navbar { background:#1a001a; padding:12px 0; display:flex; justify-content:center; gap:25px; font-weight:bold; box-shadow:0 0 10px #ff00ff; }
    .navbar a { color:orange; text-decoration:none; transition:0.2s; }
    .navbar a:hover { color:#ff00ff; text-shadow:0 0 5px #ff00ff; }
    #historyList { list-style:none; padding:0; max-width:700px; margin:20px auto; background:rgba(40,0,40,0.9); border-radius:8px; box-shadow:0 0 15px #ff00ff; max-height:500px; overflow-y:auto; text-align:left; }
    #historyList li { padding:10px; border-bottom:1px solid #333; color:white; font-size:15px; }
    #historyList li:last-child { border-bottom:none; }
    h1 { color:#ffccff; text-shadow:0 0 10px #ff00ff; }
  </style>

  <!-- ‚úÖ Load Firebase SDK TR∆Ø·ªöC -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="logo rainbow-text">üêª Bear Shop</a>
    <a href="index.html">üéÅ Case Opening</a>
    <a href="shop.html">üõí Pet Shop</a>
    <a href="inventory.html">üéí Inventory</a>
    <a href="history.html">üìú History</a>
    <a id="adminLink" href="admin_withdraws.html" style="display:none;">‚öôÔ∏è Admin</a>
    <span id="userInfo"></span>
  </nav>

  <h1>üìú Spending History</h1>
  <ul id="historyList"><li>‚è≥ Loading...</li></ul>

  <!-- ‚úÖ Script logic ƒë·∫∑t SAU khi Firebase ƒë√£ load -->
  <script>
    // ‚úÖ Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBUCFW2ffGXPBogDUyd1cDYEt15fHQiz9I",
      authDomain: "bearshop-49b90.firebaseapp.com",
      projectId: "bearshop-49b90",
      storageBucket: "bearshop-49b90.firebasestorage.app",
      messagingSenderId: "764985024020",
      appId: "1:764985024020:web:62e152b71173d2f3c89101"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const list = document.getElementById("historyList");
    const userInfoSpan = document.getElementById("userInfo");
    const adminLink = document.getElementById("adminLink");
    let currentUser = null;

    // ‚úÖ Auto Clean History >7 ng√†y
    async function autoCleanHistory() {
      try {
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const oldLogs = await db.collection("history").where("createdAt", "<", sevenDaysAgo).get();
        if (!oldLogs.empty) {
          const batch = db.batch();
          oldLogs.docs.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
        }
      } catch (err) { console.warn("AutoClean error:", err.message); }
    }

    // ‚úÖ Load History
    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.href = "login.html";

      const userDoc = await db.collection("users").doc(user.uid).get();
      if (!userDoc.exists) return auth.signOut().then(() => location.href = "login.html");

      currentUser = { uid: user.uid, ...userDoc.data() };
      renderUserUI();

      if (currentUser.isAdmin) adminLink.style.display = "inline-block";
      await autoCleanHistory();

      try {
        const snap = await db.collection("history")
          .where("userId", "==", currentUser.uid)
          .orderBy("createdAt", "desc")
          .limit(100)
          .get();

        if (snap.empty) {
          list.innerHTML = "<li>‚ö†Ô∏è No history found.</li>";
          return;
        }

        list.innerHTML = "";
        snap.forEach(doc => {
          const e = doc.data();
          const type = e.type || "unknown";
          const msg = e.msg || "";
          const date = e.createdAt ? e.createdAt.toDate().toLocaleString() : (e.date || "Unknown");
          const color = type === "case" ? "#00ffff" : type === "buy" ? "lime" : "orange";
          list.innerHTML += `
            <li>
              <b style="color:${color}">[${type.toUpperCase()}]</b>
              <span style="color:#ffccff">(${date})</span> - ${msg}
            </li>`;
        });
      } catch (err) {
        list.innerHTML = `<li style="color:red">‚ùå Error loading history: ${err.message}</li>`;
      }
    });

    function renderUserUI() {
      userInfoSpan.innerHTML = `
        üë§ ${currentUser.username} | üí∞ $${(currentUser.balance || 0).toFixed(2)}
        <button id="addFundsBtn" style="background:#0080ff;color:white;border:none;padding:4px 10px;border-radius:4px;margin-left:5px;">Add Funds</button>
        <button id="logoutBtn" style="background:red;color:white;border:none;padding:4px 10px;border-radius:4px;margin-left:5px;">Logout</button>
      `;
      document.getElementById("logoutBtn").onclick = () => auth.signOut().then(() => location.href = "login.html");
      document.getElementById("addFundsBtn").onclick = showAddFundsDialog;
    }

    function showAddFundsDialog() {
      if (document.getElementById("fundPopup")) return;
      const p = document.createElement("div");
      p.id = "fundPopup";
      p.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#000c;padding:20px;color:white;border-radius:8px;box-shadow:0 0 15px #ff00ff;z-index:2000;text-align:center;max-width:350px";
      p.innerHTML = `
        <h2>Add Funds</h2>
        <p>Contact admin on Discord:</p>
        <p><a href="https://discord.gg/Cheapestgag" target="_blank" style="color:#00ffff">BearShop Server</a></p>
        <button onclick="document.getElementById('fundPopup').remove()" style="margin-top:10px;background:#ff00ff;border:none;padding:6px 12px;border-radius:5px;color:white">Close</button>
      `;
      document.body.appendChild(p);
    }
  </script>
</body>
</html>
